<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>الإيرادات | مؤسسة عدنان سماره لنقل المياه</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f9fafc; }
    .container { margin-top: 30px; }
    table th, table td { vertical-align: middle !important; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-primary fw-bold mb-4">إضافة إيراد جديد</h2>

    <form id="revForm" class="row g-3">
      <div class="col-md-2">
        <label class="form-label">التاريخ</label>
        <input type="text" id="revDate" class="form-control" disabled>
      </div>

      <div class="col-md-2">
        <label class="form-label">المبلغ</label>
        <input type="number" id="amount" class="form-control" required>
      </div>

      <div class="col-md-2">
        <label class="form-label">نوع الدفع</label>
        <select id="payment_type" class="form-select">
          <option value="cash">كاش</option>
          <option value="credit">ذمم</option>
          <option value="visa">فيزا</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">نوع النقلة</label>
        <select id="tank_type" class="form-select">
          <option value="3 متر" data-capacity="3">3 متر</option>
          <option value="8 متر" data-capacity="8">8 متر</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">كمية المياه (م³)</label>
        <input type="number" id="water_amount" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">مصدر الماء</label>
        <select id="source_type" class="form-select">
          <option value="نقد">نقد</option>
          <option value="ذمم">ذمم</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">اسم السائق</label>
        <input type="text" id="driver_name" class="form-control" placeholder="اسم السائق">
      </div>

      <div class="col-md-3">
        <label class="form-label">رقم المركبة</label>
        <input type="text" id="vehicle_number" class="form-control" placeholder="رقم السيارة">
      </div>

      <div class="col-md-6">
        <label class="form-label">ملاحظات</label>
        <input type="text" id="notes" class="form-control" placeholder="اختياري">
      </div>

      <div class="col-12 text-end mt-2">
        <button class="btn btn-primary"><i class="fa fa-plus"></i> إضافة الإيراد</button>
      </div>
    </form>

    <hr>

    <h3 class="text-primary fw-bold mb-3">فلاتر البحث</h3>
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label class="form-label">من تاريخ</label>
        <input type="date" id="f_from" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">إلى تاريخ</label>
        <input type="date" id="f_to" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">السائق</label>
        <input id="f_driver" class="form-control" placeholder="ابحث باسم السائق">
      </div>
      <div class="col-md-3">
        <label class="form-label">رقم المركبة</label>
        <input id="f_vehicle" class="form-control" placeholder="ابحث برقم المركبة">
      </div>
      <div class="col-12 text-end">
        <button id="btnFilter" class="btn btn-outline-primary">تصفية النتائج</button>
      </div>
    </div>

    <table class="table table-striped table-bordered" id="revTable">
      <thead class="table-primary">
        <tr>
          <th>التاريخ</th>
          <th>المبلغ</th>
          <th>طريقة الدفع</th>
          <th>نوع النقلة</th>
          <th>كمية المياه</th>
          <th>السائق</th>
          <th>المركبة</th>
          <th>المصدر</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const API = 'https://adnansamarabackend.onrender.com/api/revenue';
document.getElementById('revDate').value = new Date().toLocaleDateString('ar-EG');

document.getElementById('revForm').addEventListener('submit', async e => {
  e.preventDefault();
  const body = {
    amount: document.getElementById('amount').value,
    payment_type: document.getElementById('payment_type').value,
    tank_type: document.getElementById('tank_type').value,
    water_amount: document.getElementById('water_amount').value,
    source_type: document.getElementById('source_type').value,
    driver_name: document.getElementById('driver_name').value,
    vehicle_number: document.getElementById('vehicle_number').value,
    notes: document.getElementById('notes').value
  };
  const res = await fetch(API, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const data = await res.json();
  if (!res.ok) return alert('خطأ: '+data.error);
  alert('✅ تمت الإضافة بنجاح');
  loadData();
});

function parseMeta(notes) {
  try {
    if (!notes.includes('##META##')) return {};
    const j = notes.split('##META##')[1];
    return JSON.parse(j);
  } catch { return {}; }
}

let allData = [];
async function loadData() {
  const res = await fetch(API);
  const rows = await res.json();
  allData = rows;
  render(rows);
}

function render(rows) {
  const tbody = document.querySelector('#revTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const meta = parseMeta(r.notes || '');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.amount}</td>
      <td>${meta.payment_type || r.type || ''}</td>
      <td>${meta.tank_type || ''}</td>
      <td>${meta.water_amount || ''}</td>
      <td>${meta.driver_name || ''}</td>
      <td>${meta.vehicle_number || ''}</td>
      <td>${r.source || ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('btnFilter').addEventListener('click', () => {
  const d = document.getElementById('f_driver').value;
  const v = document.getElementById('f_vehicle').value;
  const ffrom = document.getElementById('f_from').value;
  const fto = document.getElementById('f_to').value;
  const filtered = allData.filter(r => {
    const meta = parseMeta(r.notes || '');
    const matchDriver = d ? (meta.driver_name || '').includes(d) : true;
    const matchVehicle = v ? (meta.vehicle_number || '').includes(v) : true;
    const matchDate = (!ffrom || r.date >= ffrom) && (!fto || r.date <= fto);
    return matchDriver && matchVehicle && matchDate;
  });
  render(filtered);
});

loadData();
</script>
</body>
</html>
