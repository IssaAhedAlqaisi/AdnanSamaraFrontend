/* global api */

// أدوات صغيرة
const onlyDate = (d)=> typeof d === 'string' ? d.split('T')[0] : (d || '');
const fmt      = (n)=> (n==null||n==='') ? '0.00' : Number(n).toFixed(2);
const payOf    = (r)=> r?.payment_type ?? r?.payment_method ?? r?.pay_method ?? '-';

// حالة
let REVENUE = [];
let EXPENSES = [];

// عناصر الإيرادات
const revRows   = document.getElementById('revRows');
const revFromEl = document.getElementById('revFrom');
const revToEl   = document.getElementById('revTo');
const revClient = document.getElementById('revClient');
const revPay    = document.getElementById('revPay');
const revApply  = document.getElementById('revApply');
const revClear  = document.getElementById('revClear');
const revTotal  = document.getElementById('revTotal');

// عناصر المصاريف
const expRows   = document.getElementById('expRows');
const expFromEl = document.getElementById('expFrom');
const expToEl   = document.getElementById('expTo');
const expOwner  = document.getElementById('expOwner');
const expPay    = document.getElementById('expPay');
const expApply  = document.getElementById('expApply');
const expClear  = document.getElementById('expClear');
const expTotal  = document.getElementById('expTotal');

// الملخص
const sumRevEl   = document.getElementById('sumRev');
const sumExpEl   = document.getElementById('sumExp');
const netProfit  = document.getElementById('netProfit');
const profitPct  = document.getElementById('profitPct');

// طباعة جدول
window.printTable = function(tableId){
  const table = document.getElementById(tableId);
  if (!table) return;
  const w = window.open('', '_blank', 'width=900,height=700');
  w.document.write(`
    <!doctype html><html lang="ar" dir="rtl"><head>
      <meta charset="utf-8"><title>طباعة</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
      <style>body{font-family:"Cairo",sans-serif;padding:16px}</style>
    </head><body>${table.outerHTML}
    <script>window.onload=function(){window.print();window.onfocus=function(){setTimeout(()=>window.close(),300);}}<\/script>
    </body></html>
  `);
  w.document.close();
};

// تحميل
async function loadRevenue(){
  try{
    const list = await api.get('/revenue');      // نفس اندبوينتكم القديم
    REVENUE = Array.isArray(list) ? list : [];
    renderRevenue(REVENUE);
  }catch(e){
    revRows.innerHTML = `<tr><td colspan="4" class="text-danger">فشل تحميل الإيرادات</td></tr>`;
  }
}

async function loadExpenses(){
  try{
    const list = await api.get('/expenses');     // نفس اندبوينت المصاريف
    EXPENSES = Array.isArray(list) ? list : [];
    renderExpenses(EXPENSES);
  }catch(e){
    expRows.innerHTML = `<tr><td colspan="5" class="text-danger">فشل تحميل المصاريف</td></tr>`;
  }
}

// فلترة وعرض — الإيرادات
function applyRevFilter(data){
  const f = revFromEl.value || '';
  const t = revToEl.value || '';
  const c = (revClient.value || '').trim();
  const p = (revPay.value || '').trim().toLowerCase();

  return data.filter(r=>{
    const d  = onlyDate(r.date);
    const nm = (r.driver_name || '').trim();     // اسم العميل من نفس الحقل القديم
    const py = (payOf(r) || '').toString().toLowerCase();

    if (f && d < f) return false;
    if (t && d > t) return false;
    if (c && !nm.includes(c)) return false;
    if (p && py !== p) return false;
    return true;
  });
}
function renderRevenue(all){
  const list = applyRevFilter(all);
  if (!list.length){
    revRows.innerHTML = `<tr><td colspan="4" class="text-muted">لا توجد بيانات</td></tr>`;
  }else{
    revRows.innerHTML = list.map(r=>`
      <tr>
        <td>${onlyDate(r.date) || '-'}</td>
        <td>${r.driver_name || '-'}</td>
        <td>${payOf(r)}</td>
        <td>${fmt(r.amount)}</td>
      </tr>
    `).join('');
  }
  const total = list.reduce((s,r)=> s + Number(r.amount || 0), 0);
  revTotal.textContent = fmt(total);
  updateSummary();
}

// فلترة وعرض — المصاريف
function applyExpFilter(data){
  const f = expFromEl.value || '';
  const t = expToEl.value || '';
  const o = (expOwner.value || '').trim();
  const p = (expPay.value || '').trim().toLowerCase();

  return data.filter(r=>{
    const d  = onlyDate(r.date);
    const ow = (r.beneficiary || '').trim();
    const py = (r.pay_method || '').toString().toLowerCase();

    if (f && d < f) return false;
    if (t && d > t) return false;
    if (o && !ow.includes(o)) return false;
    if (p && py !== p) return false;
    return true;
  });
}
function renderExpenses(all){
  const list = applyExpFilter(all);
  if (!list.length){
    expRows.innerHTML = `<tr><td colspan="5" class="text-muted">لا توجد بيانات</td></tr>`;
  }else{
    expRows.innerHTML = list.map(r=>`
      <tr>
        <td>${onlyDate(r.date) || '-'}</td>
        <td>${r.type_name || '-'}</td>
        <td>${r.beneficiary || '-'}</td>
        <td>${r.pay_method || '-'}</td>
        <td>${fmt(r.amount)}</td>
      </tr>
    `).join('');
  }
  const total = list.reduce((s,r)=> s + Number(r.amount || 0), 0);
  expTotal.textContent = fmt(total);
  updateSummary();
}

// الملخص
function updateSummary(){
  const revSum = Number((revTotal.textContent || '0').replace(/,/g,''));
  const expSum = Number((expTotal.textContent || '0').replace(/,/g,''));
  const net    = revSum - expSum;
  const pct    = revSum > 0 ? (net / revSum * 100) : 0;

  sumRevEl.textContent  = fmt(revSum);
  sumExpEl.textContent  = fmt(expSum);
  netProfit.textContent = fmt(net);
  profitPct.textContent = `${pct.toFixed(2)}%`;
}

// أحداث الفلترة
revApply?.addEventListener('click', ()=> renderRevenue(REVENUE));
revClear?.addEventListener('click', ()=>{
  revFromEl.value = revToEl.value = revClient.value = ''; revPay.value='';
  renderRevenue(REVENUE);
});
expApply?.addEventListener('click', ()=> renderExpenses(EXPENSES));
expClear?.addEventListener('click', ()=>{
  expFromEl.value = expToEl.value = expOwner.value = ''; expPay.value='';
  renderExpenses(EXPENSES);
});

// تشغيل أولي
(function init(){
  loadRevenue();
  loadExpenses();
})();
